name: UI/UX í†µí•© í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/attendance/web/**'
      - '.github/workflows/ui-ux-testing.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/attendance/web/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: services/attendance/web

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸
  unit-integration-tests:
    name: ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_attendance
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: services/attendance/web/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: TypeScript íƒ€ì… ì²´í¬
      run: npx tsc --noEmit

    - name: ESLint ê²€ì‚¬
      run: npx eslint . --ext .ts,.tsx,.js,.jsx --format json --output-file eslint-results.json || true

    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:unit -- --coverage --coverageReporters=json --coverageReporters=lcov
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_attendance
        REDIS_URL: redis://localhost:6379

    - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:integration
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_attendance
        REDIS_URL: redis://localhost:6379
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}

    - name: UI/UX í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test -- --testPathPattern="ui-ux-integration" --coverage=false
      env:
        NODE_ENV: test

    - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./services/attendance/web/coverage/lcov.info
        flags: unittests
        name: attendance-web-coverage

    - name: ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸ ìƒì„±
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./services/attendance/web/coverage/lcov.info
        delete-old-comments: true

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.node-version }}
        path: |
          services/attendance/web/coverage/
          services/attendance/web/eslint-results.json
        retention-days: 7

  # E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-integration-tests
    
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, firefox, webkit, Mobile Chrome, Mobile Safari]

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: services/attendance/web/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: Playwright ì„¤ì¹˜
      run: npx playwright install --with-deps ${{ matrix.project }}

    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}

    - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npx playwright test --project=${{ matrix.project }} --reporter=html
      env:
        BASE_URL: http://localhost:3002
        NODE_ENV: test
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}

    - name: E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report-${{ matrix.project }}
        path: |
          services/attendance/web/test-results/
          services/attendance/web/playwright-report/
        retention-days: 7

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-integration-tests

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: services/attendance/web/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      run: npm run build
      env:
        NODE_ENV: production

    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test -- --testPathPattern="performance" --maxWorkers=1
      env:
        NODE_ENV: test

    - name: Lighthouse CI ì‹¤í–‰
      uses: treosh/lighthouse-ci-action@v9
      with:
        configPath: './services/attendance/web/lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: services/attendance/web/performance-results/
        retention-days: 7

  # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  accessibility-tests:
    name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-integration-tests

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: services/attendance/web/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: Playwright ì„¤ì¹˜
      run: npx playwright install --with-deps chromium

    - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npx playwright test --project=accessibility
      env:
        BASE_URL: http://localhost:3002

    - name: Pa11y ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
      run: |
        npm install -g pa11y
        npm run dev &
        sleep 30
        pa11y http://localhost:3002 --reporter json > accessibility-report.json || true
        pa11y http://localhost:3002/login --reporter json >> accessibility-report.json || true
        pa11y http://localhost:3002/dashboard --reporter json >> accessibility-report.json || true

    - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: accessibility-results
        path: |
          services/attendance/web/accessibility-report.json
          services/attendance/web/test-results/
        retention-days: 7

  # ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  security-tests:
    name: ë³´ì•ˆ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: services/attendance/web/package-lock.json

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: npm audit ì‹¤í–‰
      run: npm audit --audit-level moderate --production

    - name: Snyk ë³´ì•ˆ ìŠ¤ìº”
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium

    - name: OWASP ZAP ìŠ¤ìº”
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        target: 'http://localhost:3002'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'

  # ì¢…í•© í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
  quality-report:
    name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [unit-integration-tests, e2e-tests, performance-tests, accessibility-tests, security-tests]
    if: always()

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        path: test-artifacts/

    - name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        cat > quality-report.md << 'EOF'
        # UI/UX í†µí•© í…ŒìŠ¤íŠ¸ í’ˆì§ˆ ë¦¬í¬íŠ¸
        
        ## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì•½
        - **ì‹¤í–‰ ì‹œê°„**: ${{ github.run_number }}
        - **ì»¤ë°‹**: ${{ github.sha }}
        - **ë¸Œëœì¹˜**: ${{ github.ref_name }}
        
        ## í…ŒìŠ¤íŠ¸ ê²°ê³¼
        ### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        - âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.unit-integration-tests.result }}
        - âœ… í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.unit-integration-tests.result }}
        
        ### E2E í…ŒìŠ¤íŠ¸
        - ğŸŒ í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì €: ${{ needs.e2e-tests.result }}
        
        ### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        - âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ${{ needs.performance-tests.result }}
        
        ### ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
        - â™¿ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸: ${{ needs.accessibility-tests.result }}
        
        ### ë³´ì•ˆ í…ŒìŠ¤íŠ¸
        - ğŸ›¡ï¸ ë³´ì•ˆ í…ŒìŠ¤íŠ¸: ${{ needs.security-tests.result }}
        
        ## í’ˆì§ˆ ë©”íŠ¸ë¦­
        - **ì½”ë“œ ì»¤ë²„ë¦¬ì§€**: [Codecov ë¦¬í¬íŠ¸ í™•ì¸](https://codecov.io/gh/${{ github.repository }})
        - **ì„±ëŠ¥ ì ìˆ˜**: [Lighthouse ë¦¬í¬íŠ¸ í™•ì¸]
        - **ì ‘ê·¼ì„± ì ìˆ˜**: [Pa11y ë¦¬í¬íŠ¸ í™•ì¸]
        
        ## ê¶Œì¥ì‚¬í•­
        ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œ ê²½ìš°ì—ë§Œ ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
        EOF

    - name: í’ˆì§ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30

    - name: PR ì½”ë©˜íŠ¸ ìƒì„±
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

  # ë°°í¬ ê°€ëŠ¥ì„± ì²´í¬
  deployment-readiness:
    name: ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    needs: [unit-integration-tests, e2e-tests, performance-tests, accessibility-tests, security-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      run: |
        echo "ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸ ì¤‘..."
        
        # ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
        if [[ "${{ needs.unit-integration-tests.result }}" == "success" && \
              "${{ needs.e2e-tests.result }}" == "success" && \
              "${{ needs.performance-tests.result }}" == "success" && \
              "${{ needs.accessibility-tests.result }}" == "success" && \
              "${{ needs.security-tests.result }}" == "success" ]]; then
          echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "deployment_ready=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ë°°í¬ ë¶ˆê°€"
          echo "deployment_ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ë°°í¬ íƒœê·¸ ìƒì„±
      if: steps.deployment-readiness.outputs.deployment_ready == 'true'
      run: |
        git tag "ui-ux-test-passed-$(date +%Y%m%d-%H%M%S)"
        git push origin --tags